{% extends "layout/default.html" %}

{% block main_content %}
<!-- 现代化样式定义 -->
<style>
:root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --success-gradient: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
    --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    --hover-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
    --border-radius: 12px;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.modern-page {
    min-height: 100vh;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    padding: 20px 0;
}

.modern-header {
    text-align: center;
    margin-bottom: 40px;
    padding: 30px 0;
}

.modern-header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 10px;
}

.modern-header p {
    font-size: 1.1rem;
    color: #6c757d;
    font-weight: 300;
}

.modern-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: var(--border-radius);
    box-shadow: var(--card-shadow);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: var(--transition);
    margin-bottom: 30px;
    overflow: hidden;
}

.modern-card:hover {
    box-shadow: var(--hover-shadow);
    transform: translateY(-5px);
}

.modern-card-header {
    background: var(--primary-gradient);
    color: white;
    padding: 20px 25px;
    border-bottom: none;
}

.modern-card-header h4 {
    margin: 0;
    font-weight: 600;
    font-size: 1.2rem;
}

.modern-card-body {
    padding: 30px 25px;
}

.modern-form-group {
    margin-bottom: 25px;
}

.modern-label {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
    display: block;
    font-size: 0.95rem;
}

.modern-input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    transition: var(--transition);
    font-size: 1rem;
    background: white;
}

.modern-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    transform: translateY(-1px);
}

.modern-radio-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.modern-radio-item {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    transition: var(--transition);
    cursor: pointer;
    background: white;
}

.modern-radio-item:hover {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.05);
}

.modern-radio-item.active {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.1);
}

.modern-radio-item input[type="radio"] {
    margin-right: 12px;
    transform: scale(1.2);
}

.modern-btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: var(--transition);
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
    text-decoration: none;
}

.modern-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.modern-btn-primary {
    background: var(--primary-gradient);
    color: white;
}

.modern-btn-success {
    background: var(--success-gradient);
    color: white;
}

.modern-btn-warning {
    background: var(--warning-gradient);
    color: white;
}

.modern-btn-info {
    background: var(--info-gradient);
    color: white;
}

.modern-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.modern-progress {
    background: #e9ecef;
    border-radius: 10px;
    height: 8px;
    overflow: hidden;
    margin: 20px 0;
}

.modern-progress-bar {
    height: 100%;
    background: var(--success-gradient);
    border-radius: 10px;
    transition: width 0.3s ease;
}

.modern-alert {
    padding: 16px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid;
    background: white;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.modern-alert-info {
    border-left-color: #4facfe;
    background: linear-gradient(90deg, rgba(79, 172, 254, 0.1) 0%, rgba(255, 255, 255, 1) 20%);
}

.modern-alert-warning {
    border-left-color: #f093fb;
    background: linear-gradient(90deg, rgba(240, 147, 251, 0.1) 0%, rgba(255, 255, 255, 1) 20%);
}

.modern-alert-success {
    border-left-color: #4ecdc4;
    background: linear-gradient(90deg, rgba(78, 205, 196, 0.1) 0%, rgba(255, 255, 255, 1) 20%);
}

.modern-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.modern-stat-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    transition: var(--transition);
}

.modern-stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.modern-stat-number {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 5px;
}

.modern-stat-label {
    color: #6c757d;
    font-size: 0.9rem;
    font-weight: 500;
}

.modern-example-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
}

.modern-example-btn {
    padding: 12px 16px;
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    transition: var(--transition);
    cursor: pointer;
    text-align: center;
    font-size: 0.9rem;
}

.modern-example-btn:hover {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.05);
    transform: translateY(-2px);
}

.fade-in {
    animation: fadeIn 0.6s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.slide-up {
    animation: slideUp 0.4s ease-out;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* 响应式设计 */
@media (max-width: 768px) {
    .modern-header h1 {
        font-size: 2rem;
    }
    
    .modern-card-body {
        padding: 20px 15px;
    }
    
    .modern-stats {
        grid-template-columns: 1fr;
    }
    
    .modern-example-grid {
        grid-template-columns: 1fr;
    }
}

/* 深色模式支持 */
@media (prefers-color-scheme: dark) {
    .modern-page {
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    }
    
    .modern-card {
        background: rgba(45, 45, 45, 0.95);
        color: white;
    }
    
    .modern-input {
        background: #333;
        color: white;
        border-color: #555;
    }
    
    .modern-radio-item {
        background: #333;
        border-color: #555;
        color: white;
    }
}
</style>

<div class="modern-page">
    <div class="container">
        <div class="row">
        <div class="row">
            <!-- 左侧：下载配置 -->
            <div class="col-lg-6 col-md-12">
                <div class="modern-card slide-up">
                    <div class="modern-card-header">
                        <h4><i class="fa fa-cog"></i> 股票数据下载配置</h4>
                    </div>
                    
                    <div class="modern-card-body">
                        <form id="downloadForm">
                            <div class="modern-form-group">
                                <label class="modern-label">
                                    <i class="fa fa-search"></i> 检查范围
                                </label>
                                <div class="modern-radio-group">
                                    <div class="modern-radio-item active" data-value="single">
                                        <input type="radio" name="checkScope" value="single" checked>
                                        <div>
                                            <strong>单个股票检查</strong>
                                            <div style="font-size: 0.85rem; color: #6c757d; margin-top: 2px;">
                                                精准检查指定股票的数据完整性
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modern-radio-item" data-value="all">
                                        <input type="radio" name="checkScope" value="all">
                                        <div>
                                            <strong>全量数据检查</strong>
                                            <div style="font-size: 0.85rem; color: #6c757d; margin-top: 2px;">
                                                检查所有股票的数据完整性（耗时较长）
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modern-radio-item" data-value="market">
                                        <input type="radio" name="checkScope" value="market">
                                        <div>
                                            <strong>按市场检查</strong>
                                            <div style="font-size: 0.85rem; color: #6c757d; margin-top: 2px;">
                                                分别检查沪深北各交易所数据
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="modern-form-group" id="stockCodeGroup">
                                <label class="modern-label" for="stockCode">
                                    <i class="fa fa-code"></i> 股票代码
                                </label>
                                <input type="text" id="stockCode" class="modern-input" 
                                       placeholder="请输入6位股票代码，如：600000" maxlength="6">
                                <div style="font-size: 0.85rem; color: #6c757d; margin-top: 5px;">
                                    <i class="fa fa-info-circle"></i> 支持沪深北三大交易所股票代码
                                </div>
                            </div>
                            
                            <div class="modern-form-group" id="marketGroup" style="display: none;">
                                <label class="modern-label" for="marketSelect">
                                    <i class="fa fa-building"></i> 市场选择
                                </label>
                                <select id="marketSelect" class="modern-input">
                                    <option value="SH">🏛️ 上海交易所 (SH)</option>
                                    <option value="SZ">🏢 深圳交易所 (SZ)</option>
                                    <option value="BJ">🏤 北京交易所 (BJ)</option>
                                    <option value="ALL">🌐 全部市场</option>
                                </select>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="modern-form-group">
                                        <label class="modern-label" for="startDate">
                                            <i class="fa fa-calendar"></i> 开始日期
                                        </label>
                                        <input type="date" id="startDate" class="modern-input">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="modern-form-group">
                                        <label class="modern-label" for="endDate">
                                            <i class="fa fa-calendar"></i> 结束日期
                                        </label>
                                        <input type="date" id="endDate" class="modern-input" value="{{date_now}}">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="modern-form-group">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="writeToDb" style="transform: scale(1.2);">
                                    <label for="writeToDb" style="margin: 0; font-weight: 500;">
                                        <i class="fa fa-database"></i> 下载后自动写入数据库
                                    </label>
                                </div>
                                <div style="font-size: 0.85rem; color: #6c757d; margin-top: 5px; margin-left: 30px;">
                                    勾选后将自动去重并写入ClickHouse数据库
                                </div>
                            </div>
                            
                            <div class="modern-form-group" style="margin-top: 30px;">
                                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                    <button type="button" class="modern-btn modern-btn-info" id="checkDataBtn">
                                        <i class="fa fa-search"></i> 检查数据完整性
                                    </button>
                                    <button type="button" class="modern-btn modern-btn-success" id="downloadBtn" disabled>
                                        <i class="fa fa-download"></i> 开始下载
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- 快速示例 -->
                <div class="modern-card slide-up" style="animation-delay: 0.1s;">
                    <div class="modern-card-header" style="background: var(--success-gradient);">
                        <h4><i class="fa fa-star"></i> 热门股票快选</h4>
                    </div>
                    
                    <div class="modern-card-body">
                        <div class="modern-example-grid">
                            <div class="modern-example-btn" onclick="fillExample('600000', '浦发银行')">
                                <div style="font-weight: 600;">600000</div>
                                <div style="font-size: 0.85rem; color: #6c757d;">浦发银行</div>
                            </div>
                            <div class="modern-example-btn" onclick="fillExample('000001', '平安银行')">
                                <div style="font-weight: 600;">000001</div>
                                <div style="font-size: 0.85rem; color: #6c757d;">平安银行</div>
                            </div>
                            <div class="modern-example-btn" onclick="fillExample('600036', '招商银行')">
                                <div style="font-weight: 600;">600036</div>
                                <div style="font-size: 0.85rem; color: #6c757d;">招商银行</div>
                            </div>
                            <div class="modern-example-btn" onclick="fillExample('600519', '贵州茅台')">
                                <div style="font-weight: 600;">600519</div>
                                <div style="font-size: 0.85rem; color: #6c757d;">贵州茅台</div>
                            </div>
                            <div class="modern-example-btn" onclick="fillExample('000002', '万科A')">
                                <div style="font-weight: 600;">000002</div>
                                <div style="font-size: 0.85rem; color: #6c757d;">万科A</div>
                            </div>
                            <div class="modern-example-btn" onclick="fillExample('831827', '德力股份')">
                                <div style="font-weight: 600;">831827</div>
                                <div style="font-size: 0.85rem; color: #6c757d;">德力股份(BJ)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧：数据状态和下载进度 -->
            <div class="col-lg-6 col-md-12">
                <!-- 数据完整性检查结果 -->
                <div class="modern-card slide-up" id="checkResultBox" style="display: none; animation-delay: 0.2s;">
                    <div class="modern-card-header" style="background: var(--info-gradient);">
                        <h4><i class="fa fa-chart-pie"></i> 数据完整性分析</h4>
                    </div>
                    
                    <div class="modern-card-body" id="checkResult">
                        <!-- 检查结果将在这里显示 -->
                    </div>
                </div>
                
                <!-- 下载进度 -->
                <div class="modern-card slide-up" id="progressBox" style="display: none; animation-delay: 0.3s;">
                    <div class="modern-card-header" style="background: var(--warning-gradient);">
                        <h4><i class="fa fa-tasks"></i> 任务进度监控</h4>
                    </div>
                    
                    <div class="modern-card-body">
                        <div class="modern-progress">
                            <div class="modern-progress-bar" id="progressBar" style="width: 0%"></div>
                        </div>
                        <p id="progressMessage" style="text-align: center; margin: 15px 0; font-weight: 500;">等待开始...</p>
                        <div id="downloadResult" style="display: none;">
                            <!-- 下载结果将在这里显示 -->
                        </div>
                    </div>
                </div>
                
                <!-- 操作指南 -->
                <div class="modern-card slide-up" style="animation-delay: 0.4s;">
                    <div class="modern-card-header" style="background: var(--dark-gradient);">
                        <h4><i class="fa fa-graduation-cap"></i> 使用指南</h4>
                    </div>
                    
                    <div class="modern-card-body">
                        <div class="modern-alert modern-alert-info">
                            <h5 style="margin-bottom: 15px;"><i class="fa fa-lightbulb-o"></i> 快速上手</h5>
                            <ol style="margin: 0; padding-left: 20px;">
                                <li style="margin-bottom: 8px;">选择检查范围并输入股票代码或选择市场</li>
                                <li style="margin-bottom: 8px;">设置查询时间范围（建议不超过2年）</li>
                                <li style="margin-bottom: 8px;">点击"检查数据完整性"分析现有数据</li>
                                <li style="margin-bottom: 8px;">如有缺失可选择批量补齐数据</li>
                                <li style="margin-bottom: 8px;">点击"开始下载"生成CSV文件</li>
                            </ol>
                        </div>
                        
                        <div class="modern-alert modern-alert-warning">
                            <h5 style="margin-bottom: 15px;"><i class="fa fa-exclamation-triangle"></i> 重要提示</h5>
                            <div style="display: grid; gap: 8px;">
                                <div><i class="fa fa-clock-o"></i> 大量数据处理可能需要较长时间</div>
                                <div><i class="fa fa-database"></i> 沪深股票使用baostock数据源</div>
                                <div><i class="fa fa-cloud"></i> 北京股票使用tushare数据源</div>
                                <div><i class="fa fa-file-excel-o"></i> 支持完整OHLC数据导出</div>
                            </div>
                        </div>
                        
                        <div class="modern-stats">
                            <div class="modern-stat-card">
                                <div class="modern-stat-number" style="color: #667eea;">3</div>
                                <div class="modern-stat-label">支持交易所</div>
                            </div>
                            <div class="modern-stat-card">
                                <div class="modern-stat-number" style="color: #4ecdc4;">5000+</div>
                                <div class="modern-stat-label">覆盖股票</div>
                            </div>
                            <div class="modern-stat-card">
                                <div class="modern-stat-number" style="color: #f093fb;">15+</div>
                                <div class="modern-stat-label">数据字段</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 现代化数据补齐对话框 -->
<div class="modal fade" id="supplementModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content" style="border: none; border-radius: 12px; overflow: hidden;">
            <div class="modal-header" style="background: var(--primary-gradient); color: white; border: none; padding: 25px;">
                <h4 class="modal-title" style="margin: 0; font-weight: 600;">
                    <i class="fa fa-magic"></i> 智能数据补齐
                </h4>
                <button type="button" class="close" data-dismiss="modal" style="color: white; opacity: 0.8; font-size: 1.5rem;">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" style="padding: 30px;">
                <div class="modern-alert modern-alert-info">
                    <i class="fa fa-info-circle"></i> 
                    检测到您要下载的数据存在缺失，我们为您提供一键补齐服务！
                </div>
                
                <div id="missingDataDetails" style="margin: 20px 0;">
                    <!-- 缺失数据详情将在这里显示 -->
                </div>
                
                <div class="modern-alert modern-alert-success">
                    <h5 style="margin-bottom: 15px;"><i class="fa fa-cogs"></i> 智能补齐策略</h5>
                    <div style="display: grid; gap: 10px;">
                        <div><i class="fa fa-check-circle" style="color: #4ecdc4;"></i> 沪深股票：baostock高质量数据源</div>
                        <div><i class="fa fa-check-circle" style="color: #4ecdc4;"></i> 北京股票：tushare专业数据源</div>
                        <div><i class="fa fa-check-circle" style="color: #4ecdc4;"></i> 自动去重与数据验证</div>
                        <div><i class="fa fa-check-circle" style="color: #4ecdc4;"></i> 支持断点续传与批量处理</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="padding: 20px 30px; border: none; background: #f8f9fa;">
                <button type="button" class="modern-btn" data-dismiss="modal" 
                        style="background: #6c757d; color: white;">
                    <i class="fa fa-times"></i> 跳过补齐
                </button>
                <button type="button" class="modern-btn modern-btn-primary" id="confirmSupplementBtn">
                    <i class="fa fa-magic"></i> 开始补齐
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// 全局变量
let currentTaskId = null;
let checkResultData = null;

// 页面加载完成后初始化
$(document).ready(function() {
    // 初始化现代化交互
    initModernInteractions();
    
    // 设置默认开始日期为一年前
    const oneYearAgo = new Date();
    oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
    document.getElementById('startDate').valueAsDate = oneYearAgo;
    
    // 绑定事件
    $('#checkDataBtn').click(checkDataCompleteness);
    $('#downloadBtn').click(startDownload);
    $('#confirmSupplementBtn').click(confirmSupplement);
    
    // 现代化单选框处理
    $('.modern-radio-item').click(function() {
        const radioInput = $(this).find('input[type="radio"]');
        radioInput.prop('checked', true);
        $('.modern-radio-item').removeClass('active');
        $(this).addClass('active');
        
        // 触发原有的change事件
        radioInput.trigger('change');
    });
    
    // 检查范围变化处理
    $('input[name="checkScope"]').change(function() {
        const scope = $(this).val();
        
        // 添加平滑过渡效果
        if (scope === 'single') {
            $('#marketGroup').slideUp(200);
            setTimeout(() => $('#stockCodeGroup').slideDown(200), 100);
            $('#stockCode').prop('required', true);
        } else if (scope === 'market') {
            $('#stockCodeGroup').slideUp(200);
            setTimeout(() => $('#marketGroup').slideDown(200), 100);
            $('#stockCode').prop('required', false);
        } else { // all
            $('#stockCodeGroup').slideUp(200);
            $('#marketGroup').slideUp(200);
            $('#stockCode').prop('required', false);
        }
        
        // 重置按钮状态
        updateCheckButtonState();
    });
    
    // 股票代码输入验证
    $('#stockCode').on('input', function() {
        updateCheckButtonState();
        
        // 实时验证反馈
        const code = $(this).val();
        if (code.length === 6 && /^\d{6}$/.test(code)) {
            $(this).css('border-color', '#4ecdc4');
        } else if (code.length > 0) {
            $(this).css('border-color', '#f093fb');
        } else {
            $(this).css('border-color', '#e9ecef');
        }
    });
    
    // 输入框焦点效果
    $('.modern-input').focus(function() {
        $(this).parent().addClass('focused');
    }).blur(function() {
        $(this).parent().removeClass('focused');
    });
});

// 初始化现代化交互效果
function initModernInteractions() {
    // 添加页面加载动画
    $('.modern-card').each(function(index) {
        $(this).css('animation-delay', (index * 0.1) + 's');
    });
    
    // 按钮点击波纹效果
    $('.modern-btn').click(function(e) {
        const btn = $(this);
        const ripple = $('<span class="ripple"></span>');
        const rect = this.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const x = e.clientX - rect.left - size / 2;
        const y = e.clientY - rect.top - size / 2;
        
        ripple.css({
            width: size,
            height: size,
            left: x,
            top: y
        }).appendTo(btn);
        
        setTimeout(() => ripple.remove(), 600);
    });
    
    // 添加波纹效果样式
    if (!$('#ripple-style').length) {
        $('<style id="ripple-style">').text(`
            .modern-btn {
                position: relative;
                overflow: hidden;
            }
            .ripple {
                position: absolute;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.6);
                transform: scale(0);
                animation: ripple-effect 0.6s linear;
                pointer-events: none;
            }
            @keyframes ripple-effect {
                to {
                    transform: scale(4);
                    opacity: 0;
                }
            }
        `).appendTo('head');
    }
}

// 更新检查按钮状态
function updateCheckButtonState() {
    const scope = $('input[name="checkScope"]:checked').val();
    let canCheck = false;
    
    if (scope === 'single') {
        const code = $('#stockCode').val();
        canCheck = code.length === 6 && /^\d{6}$/.test(code);
        
        if (canCheck) {
            $('#stockCode').removeClass('has-error').addClass('has-success');
        } else {
            $('#stockCode').removeClass('has-success').addClass('has-error');
        }
    } else {
        // 全量或市场检查不需要验证股票代码
        canCheck = true;
        $('#stockCode').removeClass('has-error has-success');
    }
    
    $('#checkDataBtn').prop('disabled', !canCheck);
    if (!canCheck) {
        $('#downloadBtn').prop('disabled', true);
    }
}

// 填充示例数据
function fillExample(code, name) {
    $('#stockCode').val(code).trigger('input');
    
    // 设置时间范围为最近一年
    const endDate = new Date();
    const startDate = new Date();
    startDate.setFullYear(startDate.getFullYear() - 1);
    
    document.getElementById('startDate').valueAsDate = startDate;
    document.getElementById('endDate').valueAsDate = endDate;
}

// 检查数据完整性
function checkDataCompleteness() {
    const scope = $('input[name="checkScope"]:checked').val();
    const startDate = $('#startDate').val();
    const endDate = $('#endDate').val();
    
    if (!startDate || !endDate) {
        showAlert('请填写完整的时间范围', 'warning');
        return;
    }
    
    if (new Date(startDate) >= new Date(endDate)) {
        showAlert('开始日期必须早于结束日期', 'warning');
        return;
    }
    
    let requestData = {
        action: 'check_data',
        check_scope: scope,
        start_date: startDate,
        end_date: endDate
    };
    
    if (scope === 'single') {
        const stockCode = $('#stockCode').val().trim();
        if (!stockCode || !/^\d{6}$/.test(stockCode)) {
            showAlert('请输入正确的6位股票代码', 'warning');
            return;
        }
        requestData.stock_code = stockCode;
    } else if (scope === 'market') {
        requestData.market = $('#marketSelect').val();
    }
    
    // 显示loading
    $('#checkDataBtn').prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> 检查中...');
    
    // 发送检查请求
    $.post('/instock/data_download_api', requestData, function(response) {
        if (response.success) {
            checkResultData = response;
            if (scope === 'single') {
                showCheckResult(response);
            } else {
                showBatchCheckResult(response);
            }
            $('#downloadBtn').prop('disabled', false);
        } else {
            showAlert(response.message, 'danger');
        }
    }).fail(function() {
        showAlert('检查请求失败，请稍后重试', 'danger');
    }).always(function() {
        $('#checkDataBtn').prop('disabled', false).html('<i class="fa fa-search"></i> 检查数据完整性');
    });
}

// 显示检查结果
function showCheckResult(data) {
    const completeness = data.completeness;
    const hasLoss = data.has_missing;
    
    let statusGradient = 'var(--success-gradient)';
    let statusIcon = 'check-circle';
    let statusText = '数据完整';
    let statusColor = '#4ecdc4';
    
    if (completeness < 50) {
        statusGradient = 'var(--warning-gradient)';
        statusIcon = 'exclamation-triangle';
        statusText = '严重缺失';
        statusColor = '#f093fb';
    } else if (completeness < 90) {
        statusGradient = 'var(--info-gradient)';
        statusIcon = 'info-circle';
        statusText = '部分缺失';
        statusColor = '#4facfe';
    }
    
    const resultHtml = `
        <div class="modern-stats" style="margin-bottom: 25px;">
            <div class="modern-stat-card" style="background: ${statusGradient}; color: white;">
                <div class="modern-stat-number">
                    <i class="fa fa-${statusIcon}" style="font-size: 1.5rem;"></i>
                </div>
                <div class="modern-stat-label" style="color: rgba(255,255,255,0.9);">${statusText}</div>
            </div>
            <div class="modern-stat-card">
                <div class="modern-stat-number" style="color: ${statusColor};">${completeness}%</div>
                <div class="modern-stat-label">完整性</div>
            </div>
        </div>
        
        <div class="row" style="margin-bottom: 20px;">
            <div class="col-md-6">
                <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 8px;">
                    <h6 style="color: #2c3e50; margin-bottom: 15px; font-weight: 600;">
                        <i class="fa fa-info-circle"></i> 基本信息
                    </h6>
                    <div style="display: grid; gap: 8px; font-size: 0.9rem;">
                        <div><strong>股票代码:</strong> ${data.stock_code} (${data.market})</div>
                        <div><strong>查询范围:</strong> ${data.start_date} ~ ${data.end_date}</div>
                        ${data.ipo_date ? `<div><strong>上市日期:</strong> ${data.ipo_date}</div>` : ''}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 8px;">
                    <h6 style="color: #2c3e50; margin-bottom: 15px; font-weight: 600;">
                        <i class="fa fa-chart-bar"></i> 数据统计
                    </h6>
                    <div style="display: grid; gap: 8px; font-size: 0.9rem;">
                        <div><strong>应有数据:</strong> <span style="color: #667eea;">${data.total_expected} 条</span></div>
                        <div><strong>现有数据:</strong> <span style="color: #4ecdc4;">${data.existing_count} 条</span></div>
                        <div><strong>缺失数据:</strong> <span style="color: ${statusColor};">${data.missing_count} 条</span></div>
                    </div>
                </div>
            </div>
        </div>
        
        ${hasLoss ? `
        <div class="modern-alert modern-alert-warning" style="margin-top: 20px;">
            <h5 style="margin-bottom: 15px;"><i class="fa fa-exclamation-triangle"></i> 检测到数据缺失</h5>
            <p style="margin-bottom: 15px;">为确保数据完整性，建议先补齐缺失数据后再下载。</p>
            <button type="button" class="modern-btn modern-btn-warning" onclick="showSupplementModal()">
                <i class="fa fa-magic"></i> 一键补齐数据
            </button>
        </div>
        ` : `
        <div class="modern-alert modern-alert-success">
            <i class="fa fa-check-circle"></i> 数据完整，可以直接下载
        </div>
        `}
    `;
    
    $('#checkResult').html(resultHtml);
    $('#checkResultBox').slideDown(300);
}

// 显示详细结果
function showDetailedResults() {
    $('#detailedResults').toggle();
}

// 显示批量数据补齐对话框
function showBatchSupplementModal() {
    if (!checkResultData || !checkResultData.summary) {
        return;
    }
    
    const summary = checkResultData.summary;
    const totalMissing = summary.partial_missing + summary.severe_missing;
    
    const detailsHtml = `
        <div class="alert alert-info">
            <strong>批量补齐统计：</strong><br>
            共有 <strong>${totalMissing}</strong> 只股票需要补齐数据<br>
            部分缺失: <strong>${summary.partial_missing}</strong> 只 &nbsp; 
            严重缺失: <strong>${summary.severe_missing}</strong> 只<br>
            检查范围: <strong>${checkResultData.check_scope === 'market' ? checkResultData.market + '市场' : '全量数据'}</strong>
        </div>
        
        <div class="well">
            <strong>补齐策略：</strong><br>
            <ul>
                <li>优先补齐严重缺失的股票（完整性&lt;50%）</li>
                <li>沪深股票使用baostock数据源</li>
                <li><span class="text-info">北京股票使用tushare数据源</span></li>
                <li>支持批量并发处理，提高效率</li>
            </ul>
        </div>
        
        <div class="alert alert-warning">
            <strong>注意：</strong>批量补齐可能需要较长时间，请耐心等待。沪深股票使用baostock数据源，北京股票使用tushare数据源。补齐完成后请重新检查数据完整性。
        </div>
    `;
    
    $('#missingDataDetails').html(detailsHtml);
    $('#supplementModal').modal('show');
}

// 显示批量检查结果
function showBatchCheckResult(data) {
    const scope = data.check_scope;
    const summary = data.summary;
    const details = data.details || [];
    
    let scopeText = '';
    if (scope === 'all') {
        scopeText = '全量数据';
    } else if (scope === 'market') {
        scopeText = `${data.market}市场`;
    }
    
    const completionRate = ((summary.complete_stocks / summary.total_stocks) * 100).toFixed(1);
    const partialRate = ((summary.partial_missing / summary.total_stocks) * 100).toFixed(1);
    const severeRate = ((summary.severe_missing / summary.total_stocks) * 100).toFixed(1);
    
    const resultHtml = `
        <div class="modern-alert modern-alert-info" style="margin-bottom: 25px;">
            <h5 style="margin-bottom: 10px;"><i class="fa fa-database"></i> ${scopeText}完整性分析报告</h5>
            <p style="margin: 0;"><strong>分析范围:</strong> ${data.start_date} ~ ${data.end_date}</p>
        </div>
        
        <div class="modern-stats" style="margin-bottom: 25px;">
            <div class="modern-stat-card">
                <div class="modern-stat-number" style="color: #667eea;">${summary.total_stocks}</div>
                <div class="modern-stat-label">总股票数</div>
            </div>
            <div class="modern-stat-card">
                <div class="modern-stat-number" style="color: #4ecdc4;">${summary.complete_stocks}</div>
                <div class="modern-stat-label">完整股票</div>
            </div>
            <div class="modern-stat-card">
                <div class="modern-stat-number" style="color: #4facfe;">${summary.partial_missing}</div>
                <div class="modern-stat-label">部分缺失</div>
            </div>
            <div class="modern-stat-card">
                <div class="modern-stat-number" style="color: #f093fb;">${summary.severe_missing}</div>
                <div class="modern-stat-label">严重缺失</div>
            </div>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <h6 style="margin-bottom: 15px; color: #2c3e50;"><i class="fa fa-chart-pie"></i> 数据完整性分布</h6>
            <div style="background: #f8f9fa; border-radius: 6px; height: 20px; overflow: hidden; margin-bottom: 15px;">
                <div style="background: var(--success-gradient); height: 100%; width: ${completionRate}%; float: left;"></div>
                <div style="background: var(--info-gradient); height: 100%; width: ${partialRate}%; float: left;"></div>
                <div style="background: var(--warning-gradient); height: 100%; width: ${severeRate}%; float: left;"></div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 0.9rem;">
                <div style="text-align: center;">
                    <div style="color: #4ecdc4; font-weight: 600;">${completionRate}%</div>
                    <div style="color: #6c757d;">完整数据</div>
                </div>
                <div style="text-align: center;">
                    <div style="color: #4facfe; font-weight: 600;">${partialRate}%</div>
                    <div style="color: #6c757d;">部分缺失</div>
                </div>
                <div style="text-align: center;">
                    <div style="color: #f093fb; font-weight: 600;">${severeRate}%</div>
                    <div style="color: #6c757d;">严重缺失</div>
                </div>
            </div>
        </div>
        
        ${(summary.partial_missing > 0 || summary.severe_missing > 0) ? `
        <div class="modern-alert modern-alert-warning">
            <h5 style="margin-bottom: 15px;"><i class="fa fa-exclamation-triangle"></i> 发现数据缺失</h5>
            <p style="margin-bottom: 15px;">共有 <strong>${summary.partial_missing + summary.severe_missing}</strong> 只股票存在数据缺失。</p>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button type="button" class="modern-btn modern-btn-warning" onclick="showBatchSupplementModal()">
                    <i class="fa fa-magic"></i> 批量补齐数据
                </button>
                <button type="button" class="modern-btn modern-btn-info" onclick="showDetailedResults()">
                    <i class="fa fa-list"></i> 查看详细报告
                </button>
            </div>
        </div>
        ` : `
        <div class="modern-alert modern-alert-success">
            <i class="fa fa-check-circle"></i> 所有股票数据完整，可以直接下载
        </div>
        `}
        
        ${details.length > 0 ? `
        <div id="detailedResults" style="display: none; margin-top: 20px;">
            <h6 style="color: #2c3e50; margin-bottom: 15px;"><i class="fa fa-table"></i> 详细缺失报告 (显示前20个最严重的)</h6>
            <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <div style="background: var(--dark-gradient); color: white; padding: 15px; display: grid; grid-template-columns: 1fr 1fr 2fr 1fr 1fr 1fr 1fr; gap: 10px; font-weight: 600; font-size: 0.85rem;">
                    <div>代码</div>
                    <div>市场</div>
                    <div>完整性</div>
                    <div>应有</div>
                    <div>现有</div>
                    <div>缺失</div>
                    <div>状态</div>
                </div>
                ${details.slice(0, 20).map(stock => `
                <div style="padding: 12px 15px; display: grid; grid-template-columns: 1fr 1fr 2fr 1fr 1fr 1fr 1fr; gap: 10px; border-bottom: 1px solid #e9ecef; font-size: 0.85rem; align-items: center;">
                    <div style="font-weight: 600;">${stock.code}</div>
                    <div>${stock.market}</div>
                    <div>
                        <div style="background: #f8f9fa; height: 20px; border-radius: 10px; overflow: hidden; margin-bottom: 5px;">
                            <div style="background: ${stock.completeness >= 90 ? 'var(--success-gradient)' : stock.completeness >= 50 ? 'var(--info-gradient)' : 'var(--warning-gradient)'}; height: 100%; width: ${stock.completeness}%; transition: width 0.3s ease;"></div>
                        </div>
                        <div style="text-align: center; font-weight: 600; color: ${stock.completeness >= 90 ? '#4ecdc4' : stock.completeness >= 50 ? '#4facfe' : '#f093fb'};">${stock.completeness}%</div>
                    </div>
                    <div>${stock.total_expected}</div>
                    <div>${stock.existing_count}</div>
                    <div style="color: #f093fb; font-weight: 600;">${stock.missing_count}</div>
                    <div>
                        ${stock.completeness >= 90 ? '<span style="background: var(--success-gradient); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">完整</span>' : 
                          stock.completeness >= 50 ? '<span style="background: var(--info-gradient); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">部分缺失</span>' : 
                          '<span style="background: var(--warning-gradient); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">严重缺失</span>'}
                    </div>
                </div>
                `).join('')}
            </div>
        </div>
        ` : ''}
    `;
    
    $('#checkResult').html(resultHtml);
    $('#checkResultBox').slideDown(300);
}

// 显示数据补齐对话框
function showSupplementModal() {
    if (!checkResultData || !checkResultData.has_missing) {
        return;
    }
    
    const missingCount = checkResultData.missing_count;
    const sampleDates = checkResultData.missing_dates.slice(0, 5); // 显示前5个日期作为示例
    
    const detailsHtml = `
        <div class="alert alert-info">
            <strong>缺失数据统计：</strong><br>
            总计缺失 <strong>${missingCount}</strong> 个交易日的数据
        </div>
        
        <div class="well">
            <strong>缺失日期示例（前5个）：</strong><br>
            ${sampleDates.map(date => `<span class="label label-warning">${date}</span>`).join(' ')}
            ${missingCount > 5 ? `<br><small class="text-muted">... 还有 ${missingCount - 5} 个日期</small>` : ''}
        </div>
    `;
    
    $('#missingDataDetails').html(detailsHtml);
    $('#supplementModal').modal('show');
}

// 确认补齐数据
function confirmSupplement() {
    if (!checkResultData) {
        return;
    }
    
    $('#supplementModal').modal('hide');
    
    // 根据检查范围发送不同的补齐请求
    const scope = checkResultData.check_scope;
    let requestData = {
        action: 'supplement_data'
    };
    
    if (scope === 'single') {
        // 单个股票补齐
        requestData.stock_code = checkResultData.stock_code;
        requestData.missing_dates = JSON.stringify(checkResultData.missing_dates);
    } else {
        // 批量补齐
        requestData.check_scope = scope;
        requestData.market = checkResultData.market || 'ALL';
        requestData.start_date = checkResultData.start_date;
        requestData.end_date = checkResultData.end_date;
        
        // 传递需要补齐的股票列表
        if (checkResultData.details && checkResultData.details.length > 0) {
            const missingStocks = checkResultData.details.map(stock => ({
                code: stock.code,
                market: stock.market,
                missing_count: stock.missing_count
            }));
            requestData.missing_stocks = JSON.stringify(missingStocks);
        }
    }
    
    // 开始补齐任务
    $.post('/instock/data_download_api', requestData, function(response) {
        if (response.success) {
            const message = scope === 'single' ? 
                '数据补齐任务已启动，请稍后重新检查数据完整性' : 
                `批量数据补齐任务已启动，将为${checkResultData.summary.partial_missing + checkResultData.summary.severe_missing}只股票补齐数据`;
            showAlert(message, 'info');
            
            // 跟踪任务进度
            trackTaskProgress(response.task_id, 'supplement');
        } else {
            showAlert(response.message, 'danger');
        }
    }).fail(function() {
        showAlert('补齐请求失败，请稍后重试', 'danger');
    });
}

// 开始下载
function startDownload() {
    const stockCode = $('#stockCode').val().trim();
    const startDate = $('#startDate').val();
    const endDate = $('#endDate').val();
    const writeToDb = $('#writeToDb').is(':checked');
    
    if (!stockCode || !startDate || !endDate) {
        showAlert('请填写完整的下载参数', 'warning');
        return;
    }
    
    // 禁用下载按钮
    $('#downloadBtn').prop('disabled', true);
    
    // 显示进度框
    $('#progressBox').show();
    updateProgress(0, '正在创建下载任务...');
    
    // 发送下载请求
    $.post('/instock/data_download_api', {
        action: 'download_data',
        stock_code: stockCode,
        start_date: startDate,
        end_date: endDate,
        write_to_db: writeToDb
    }, function(response) {
        if (response.success) {
            currentTaskId = response.task_id;
            showAlert(response.message, 'info');
            // 开始跟踪任务进度
            trackTaskProgress(response.task_id, 'download');
        } else {
            showAlert(response.message, 'danger');
            $('#downloadBtn').prop('disabled', false);
            $('#progressBox').hide();
        }
    }).fail(function() {
        showAlert('下载请求失败，请稍后重试', 'danger');
        $('#downloadBtn').prop('disabled', false);
        $('#progressBox').hide();
    });
}

// 跟踪任务进度
function trackTaskProgress(taskId, taskType) {
    const checkProgress = function() {
        $.post('/instock/data_download_api', {
            action: 'get_task_status',
            task_id: taskId
        }, function(response) {
            if (response.success) {
                const task = response.task;
                updateProgress(task.progress, task.message);
                
                if (task.status === 'completed') {
                    if (taskType === 'download') {
                        showDownloadResult(task);
                    } else if (taskType === 'supplement') {
                        if (task.type === 'batch_supplement') {
                            showBatchSupplementResult(task);
                        } else {
                            showAlert('任务完成：' + task.message, 'success');
                        }
                    }
                    $('#downloadBtn').prop('disabled', false);
                } else if (task.status === 'failed') {
                    showAlert('任务失败：' + task.message, 'danger');
                    $('#downloadBtn').prop('disabled', false);
                } else {
                    // 继续检查进度
                    setTimeout(checkProgress, 2000);
                }
            } else {
                showAlert('获取任务状态失败', 'danger');
                $('#downloadBtn').prop('disabled', false);
            }
        }).fail(function() {
            showAlert('任务状态查询失败', 'danger');
            $('#downloadBtn').prop('disabled', false);
        });
    };
    
    checkProgress();
}

// 显示批量补齐结果
function showBatchSupplementResult(task) {
    const resultHtml = `
        <div class="alert alert-${task.success_count === task.total_count ? 'success' : 'warning'}">
            <h5><i class="fa fa-${task.success_count === task.total_count ? 'check-circle' : 'exclamation-triangle'}"></i> 批量补齐完成</h5>
            <p><strong>成功补齐：</strong> ${task.success_count}/${task.total_count} 只股票</p>
            <p><strong>建议：</strong> 请重新检查数据完整性以验证补齐效果</p>
            <button type="button" class="btn btn-info btn-sm" onclick="checkDataCompleteness()">
                <i class="fa fa-refresh"></i> 重新检查数据完整性
            </button>
        </div>
    `;
    
    $('#downloadResult').html(resultHtml).show();
    updateProgress(100, task.message);
    
    const alertType = task.success_count === task.total_count ? 'success' : 'warning';
    showAlert(`批量数据补齐完成，成功补齐 ${task.success_count}/${task.total_count} 只股票`, alertType);
}

// 更新进度
function updateProgress(progress, message) {
    $('#progressBar').css('width', progress + '%').attr('aria-valuenow', progress);
    $('#progressMessage').text(message);
    
    // 添加进度动画效果
    if (progress === 100) {
        $('#progressBar').css('background', 'var(--success-gradient)');
        setTimeout(() => {
            $('#progressMessage').html('<i class="fa fa-check-circle" style="color: #4ecdc4;"></i> ' + message);
        }, 300);
    }
}

// 显示下载结果
function showDownloadResult(task) {
    const resultHtml = `
        <div class="modern-alert modern-alert-success">
            <h5 style="margin-bottom: 15px;"><i class="fa fa-check-circle"></i> 下载任务完成</h5>
            <div style="display: grid; gap: 10px; margin-bottom: 15px;">
                <div><strong>数据记录:</strong> <span style="color: #4ecdc4;">${task.record_count} 条</span></div>
                <div><strong>文件名:</strong> <span style="color: #667eea;">${task.filename}</span></div>
            </div>
            <a href="${task.download_url}" class="modern-btn modern-btn-success" download>
                <i class="fa fa-download"></i> 立即下载文件
            </a>
        </div>
    `;
    
    $('#downloadResult').html(resultHtml).slideDown(300);
    updateProgress(100, task.message);
    
    showAlert('数据下载完成，点击按钮保存文件', 'success');
}

// 显示消息提醒
function showAlert(message, type) {
    // 移除现有的alert
    $('.modern-page .alert-dismissible').fadeOut(200, function() {
        $(this).remove();
    });
    
    let alertClass = 'modern-alert-info';
    let iconClass = 'fa-info-circle';
    
    switch(type) {
        case 'success':
            alertClass = 'modern-alert-success';
            iconClass = 'fa-check-circle';
            break;
        case 'warning':
            alertClass = 'modern-alert-warning';
            iconClass = 'fa-exclamation-triangle';
            break;
        case 'danger':
        case 'error':
            alertClass = 'modern-alert-warning';
            iconClass = 'fa-exclamation-triangle';
            break;
    }
    
    const alertHtml = `
        <div class="modern-alert ${alertClass} alert-dismissible fade-in" style="position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
            <button type="button" class="close" style="position: absolute; right: 15px; top: 15px; color: inherit; opacity: 0.7; border: none; background: none; font-size: 1.2rem; cursor: pointer;">
                <span>&times;</span>
            </button>
            <div style="padding-right: 30px;">
                <i class="fa ${iconClass}"></i> ${message}
            </div>
        </div>
    `;
    
    $('body').append(alertHtml);
    
    // 绑定关闭事件
    $('.alert-dismissible .close').click(function() {
        $(this).parent().fadeOut(200, function() {
            $(this).remove();
        });
    });
    
    // 自动消失
    setTimeout(function() {
        $('.alert-dismissible').fadeOut(200, function() {
            $(this).remove();
        });
    }, 5000);
}
</script>

{% end %}
